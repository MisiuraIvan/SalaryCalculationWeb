<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Данные пользователя</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link href="../static/css/adminmain.css" th:href="@{/css/adminmain.css}" rel="stylesheet" />
</head>
<body>
<userheader th:insert="userheader::userheader"></userheader>
<table class="table table-striped">
    <thead>
    <tr>
        <th scope="col">#</th>
        <th scope="col">Сотрудник</th>
        <th scope="col">Дата</th>
        <th scope="col">Рабочее время</th>
        <th scope="col">Больничные</th>
        <th scope="col">Отпуск</th>
        <th scope="col">Переработки</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="el:${timesheets}">
        <th th:text="${el.timeSheetId}" scope="row"></th>
        <th th:text="${el.user.firstName}+' '+${el.user.lastName}+' '+${el.user.middleName}" scope="row"></th>
        <th th:text="${el.date.month}+' '+${el.date.year}"scope="row"></th>
        <th th:text="${el.worktime}"scope="row"></th>
        <th th:text="${el.sickleave}"scope="row"></th>
        <th th:text="${el.holiday}"scope="row"></th>
        <th th:text="${el.overtime}"scope="row"></th>
    </tr>
    </tbody>
</table>
<br>
<table class="table table-striped">
    <thead>
    <tr>
        <th scope="col">#</th>
        <th scope="col">Номер табеля</th>
        <th scope="col">Премия</th>
        <th scope="col">Зарплата</th>
        <th scope="col">Подоходный</th>
        <th scope="col">Пенсионные</th>
        <th scope="col">Чистая ЗП</th>
        <th scope="col">ФСЗН</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="el:${salaries}">
        <th th:text="${el.salaryId}" scope="row"></th>
        <th th:text="${el.timeSheet.timeSheetId}"></th>
        <th th:text="${el.award}"></th>
        <th th:text="${el.salary}"></th>
        <th th:text="${el.tax}"></th>
        <th th:text="${el.pension}"></th>
        <th th:text="${el.netsalary}"></th>
        <th th:text="${el.fszn}"></th>
    </tr>
    </tbody>
</table>
<form class="row g-3 form3" method="post">
    <h4 class="mb-3">Диаграмма фонда ЗП</h4>
    <div class="col-sm-4">
        <label class="form-label">Начальный период</label>
        <select class="form-control" id="start" name="start">
            <option th:each="el:${dates}" th:text="${el.month}+' '+${el.year}"/>
        </select>
    </div>
    <div class="col-sm-4">
        <label class="form-label">Конечный период</label>
        <select class="form-control" id="end" name="end">
            <option th:each="el:${dates}" th:text="${el.month}+' '+${el.year}"/>
        </select>
    </div>
    <div class="col-sm-4">
        <label class="form-label">Номер сотрудника</label>
        <select class="form-control" id="idd" name="idd">
            <option th:text="${user.userId}"/>
        </select>
    </div>
    <div class="col-12">
        <button class="w-100 btn btn-primary btn-lg" type="button" onclick="createUserDiagram()">Построить диаграмму ЗП сотрудника</button>
        <div class="invalid-feedback">
            Valid last name is required.
        </div>
    </div>
</form>
<br>
<div class="form3">
    <canvas id="myChart"></canvas>
</div>
<br>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let labels=[];
    let data=[];
    let config;
    let myChart=new Chart(
        document.getElementById('myChart'),
        config
    );
</script>
<script th:inline="javascript">
    function createUserDiagram(){
        let start=document.getElementById("start").value;
        let end=document.getElementById("end").value;
        let dates = [[${dates}]];
        let usersum = [[${usersum}]];
        let startid,endid;
        for(let i=0;i<dates.length;i++){
            if(start.split(" ")[0]==dates[i].month && start.split(" ")[1]==dates[i].year){
                startid=i;
                break;
            }
            if(i==dates.length-1){
                startid=-1;
            }
        }
        for(let i=0;i<dates.length;i++){
            if(end.split(" ")[0]==dates[i].month && end.split(" ")[1]==dates[i].year){
                endid=i;
                break;
            }
            if(i==dates.length-1){
                endid=-1;
            }
        }
        if(endid>startid && endid!=-1 && startid!=-1){
            let date1=[];
            labels=[];
            date1=[];
            for(let i=0;i<=endid-startid;i++) {
                labels[i] = dates[startid + i].month;
                date1[i]=usersum[0][startid+i];
            }
            data = {
                labels: labels,
                datasets: [{
                    label: 'График ЗП сотрудника',
                    backgroundColor: ['red','orange','yellow','green','skyblue','blue','purple'],
                    borderColor: 'rgb(255, 99, 132)',
                    data: date1,
                }]
            };
            config = {
                type: 'line',
                data: data,
                options: {}
            };
            myChart.destroy();
            myChart = new Chart(
                document.getElementById('myChart'),
                config
            );
        }else{
            alert("Введите корректные данные");
        }
    }
</script>
</body>
</html>